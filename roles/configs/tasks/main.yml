- name: Clone configuration repository
  ansible.builtin.git:
    repo: "{{ repo_url }}"
    version: main
    dest: "{{ temp_repo_path }}"
    force: true

- name: Find directories to copy (excluding bash and .git)
  ansible.builtin.find:
    paths: "{{ temp_repo_path }}"
    file_type: directory
    excludes: "bash,.git"
  register: config_dirs

- name: Find bash files to copy
  ansible.builtin.find:
    paths: "{{ temp_repo_path }}/bash"
    hidden: true
  register: bash_files

- name: Copy bash files to home
  ansible.builtin.copy:
    src: "{{ item.1.path }}"
    dest: "{{ item.0.home }}"
    owner: "{{ item.0.name }}"
    group: "{{ item.0.name }}"
    mode: '0755'
    force: true
  with_nested:
    - "{{ users }}"
    - "{{ bash_files.files }}"

- name: Ensure .config directories exist
  ansible.builtin.file:
    path: "{{ item.home }}/.config"
    state: directory
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: '0755'
  loop: "{{ users }}"

- name: Copy configs to users
  ansible.builtin.copy:
    src: "{{ item.0.path }}"
    dest: "{{ item.1.home }}/.config/"
    owner: "{{ item.1.name }}"
    group: "{{ item.1.name }}"
    mode: '0755'
    force: true
  with_nested:
    - "{{ config_dirs.files }}"
    - "{{ users }}"

- name: Cleanup temporary clone
  ansible.builtin.file:
    path: "{{ temp_repo_path }}"
    state: absent
